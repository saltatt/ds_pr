# -*- coding: utf-8 -*-
"""Копия блокнота "EDA_task.ipynb"

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ZiH9Ymsm9VU9kEzqYroVF7D7jRHnQsGZ

# Разведочный анализ данных

Это задание посвящено изучению данных и построению различных визуализаций.  
Наша цель - провести **разведочный анализ данных**, чтобы исследовать поведение данных и выявить в них закономерности.

Мы будем работать с датассетом пассажиров [Титаника](https://en.wikipedia.org/wiki/Titanic).

Классическая задача, решаемая на этих данных: предсказать, выжил пассажир или нет по его характеристикам.  
То есть целевая переменная - столбец `Survived`.

Цели:
* познакомиться с библиотекой `seaborn`
* научиться делать различные визуализации
* заполнять пропуски в данных
* делать однофакторный анализ
* конструировать новые признаки

Бонус:
* придумаем свою модель на основе проведенного анализа и оценим ее качество.

## Подключение библиотек и загрузка данных
"""

import pandas as pd
import numpy as np
import seaborn as sns

from matplotlib import pyplot as plt

"""Фиксируем `random_state` для воспроизводимости случайных значений.

*   Новый пункт
*   Новый пункт


"""

RANDOM_STATE = 42

"""Загрузим данные."""

Data = pd.read_csv(
    "https://raw.githubusercontent.com/evgpat/edu_stepik_practical_ml/main/datasets/titanik.csv",
    sep=";"
    )

"""**Описание признаков**

- `Survived` — выжил данный пассажир или нет (*0* для умерших, *1* для выживших)
- `Pclass` — класс пассажира (*1* — высший, *2* — средний, *3* — низший)
- `Name` — имя
- `Sex` — пол
- `Age` — возраст
- `SibSp` — количество братьев, сестер, сводных братьев, сводных сестер, супругов на борту титаника
- `Parch` — количество родителей, детей (в том числе приемных) на борту титаника
- `Ticket` — номер билета
- `Fare` — плата за проезд
- `Cabin` — каюта
- `Embarked` — порт посадки (*C* — Шербур; *Q* — Квинстаун; *S* — Саутгемптон)

## Обзор данных

Посмотрим на *5* случайных объектов из датасета.
"""

Data.sample(5)

"""Выведите на экран размеры таблицы *Data*.

**Вопрос:** сколько объектов в данных?
"""

# ваш код здесь
Data.shape

"""## Обработка признаков и однофакторный анализ

На данном этапе:

1) Найдем признаки, у которых есть пропущенные значения и обработаем эти пропущенные значения

2) Переведём категориальные признаки в числовые

Выведем на экран основные числовые характеристики числовых столбцов.  
Это можно сделать при помощи функции `describe`.
"""

Data.describe()

"""В строке *count* отображается количество непропущенных значений в каждом столбце.

Основные статистики можно посмотреть и по категориальным колонкам.  
Для этого в функцию `describe` нужно передать аргумент `include='object'`.

Сделайте это.
"""

# ваш код здесь
Data.describe(include='object')

"""**Вопрос:** в скольких категориальных колонках есть пропуски?

### Столбец Sex

В столбце пол (`Sex`) три различных значения. Посмотрим на них.
"""

Data['Sex'].value_counts()

"""Удалим пассажиров неизвестного пола, так как их всего *5*."""

Data = Data[Data['Sex'] != 'unknown']

"""Проверьте, что строки с неизвестным полом исчезли."""

# ваш код здесь
Data['Sex'].value_counts()

"""Признак `Sex` является категориальным, то есть содержит нечисловые значения. Для работы большинства алгоритмов необходимо переводить категории в числа.

Закодировать значения столбца с двумя категориями можно следующим образом. Пусть в воображаемом столбце *animal* есть два значения: *cat* и *dog*. Их можно перевести в *0* и *1* при помощи функции `map`:

`Data['animal'] = Data['animal'].map({'cat' : 1, 'dog' : 0})`

По аналогии закодируйте столбец `Sex` (*male* - *1*, *female* - *0*).
"""

Data['Sex'] = Data['Sex'].map({'male': 1, 'female': 0})

"""**Вопрос** посчитайте сумму значений в закодированном столбце `Sex`."""

# ваш код здесь
Data['Sex'].sum()

"""Посмотрим, как влияет пол на выживаемость."""

sns.barplot(x='Sex', y='Survived', hue = 'Pclass', data=Data, palette='summer')
plt.title('Sex - Survived')
plt.show();

"""Гистограмму можно детализировать, добавив значение параметра `hue`.

### Столбец Pclass

Нарисуйте гистограмму выживаемости в зависимости от `Pclass`.  
Используйте `barplot`.
"""

# ваш код здесь
sns.barplot(x='Pclass', y = 'Survived', data=Data, palette='summer')
plt.title('Survived by class')
plt.show()

"""**Вопрос:** пассажиры из какого класса выживали чаще всего?

Посмотрим, как влияет пол человека и класс билета (`Pclass`) на выживаемость
"""

sns.barplot(x='encoded_Sex', y='Survived', hue='Pclass', data=Data, palette='autumn')
plt.title('Sex - Survived')
plt.show();

"""### Столбец Embarked

**Вопрос** сколько различных значений принимает признак `Embarked`?
"""

# ваш код здесь
Data['Embarked'].nunique()

"""Пока что мы не обсуждали, как переводить в числа категориальные признаки с больше, чем двумя категориями.  
Поэтому давайте отбросим этот признак.

Сделайте это (вам пригодится метод [`drop`](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.drop.html)).
"""

# ваш код здесь
Data.drop('Embarked', axis=1, inplace=True)

"""### Столбец Age

Обработаем признак `Age`.

Мы помним, что в этом признаке много пропусков.

Заполним пропуски медианным значением `Age`.
"""

median_age = Data['Age'].median()

Data['Age'].fillna(median_age, inplace=True)

"""Нарисуем распределение возраста пассажиров."""

sns.displot(Data['Age'], kde=True)
plt.show();

"""### Другие столбцы

Удалите признак `Fare`. Он сильно связан с признаком `Pclass`, поэтому нам не нужен.
"""

# ваш код здесь
Data.drop('Fare',axis=1,inplace=True)

Data.shape

"""**Вопрос:** сколько на данный момент колонок в таблице `Data`?

Столбец `PassengerId` является категориальным и не несёт важной информации, удалите его.

Столбцы `Ticket`, `Name` и `Cabin` в этот раз нам также не понадобятся. Удалите и их.
"""

Data.drop('Fare',axis=1,inplace=True)
Data.drop('Embarked',axis=1,inplace=True)

"""После минимальной обработки данных у нас получилась следующая таблица:"""

Data.head()

"""## Исследование признаков

Нарисуйте матрицу корреляций столбцов между собой.
"""

# ваш код здесь
plt.figure(figsize=(10,10))
sns.heatmap(Data.corr(), annot=True, cmap='coolwarm', fmt=".2f")
plt.title('Матрица Кореляций')
plt.show()

"""**Вопрос:** какой столбец сильнее всего коррелирует с целевой переменной `Survived`?

Посмотрим на попарные зависимости некоторых признаков.
"""

g = sns.pairplot(
    Data,
    hue='Survived',
    palette = 'seismic',
    height=4,
    diag_kind = 'kde',
    diag_kws=dict(fill=True),
    plot_kws=dict(s=50)
    )

g.set(xticklabels=[]);

"""## Бонус (не проверяется)

Мы не используем всю информацию о данных, в частности, не используем текстовые данные. Также из матрицы корреляций мы видим, что признаки `Parch` и `SibSp` слабо коррелируют с выживаемостью (`Survived`). Можно сконструировать новые признаки, чтобы решить эти вопросы.

Попробуйте сделать следующее.

1) Создайте признак `NameLen` и запишите в него длину имени (`Name`).

2) Создайте признак `FamilySize`, равный *Parch + SibSp + 1*. Зачем добавлять 1?

3) Создайте признак `IsAlone`, который показывает, путешествовал человек один или с семьей.
"""

# ваш код здесь

"""Посмотрите, как коррелируют новые признаки со столбцом `Survived`."""

# ваш код здесь

"""Можно извлечь и другую полезную информацию из данных путём конструирования новых признаков.

Придумайте ещё новые осмысленные признаки. Проверьте, как они коррелируют с выживаемостью.
"""

# ваш код здесь

"""Мы провели  однофакторный анализ данных и увидели, какие признаки сильно влияют на выживаемость, а какие нет.

Мы видим, что больше всего на выживаемость влияет пол пассажира.

### Наша собственная модель

Напишем свою модель, предсказывающую выживаемость только по признаку `Sex`.
"""

def prediction(x):
    if x.Sex == 1:
        return 0
    return 1

"""Посчитаем долю правильных ответов нашей модели."""

from sklearn.metrics import accuracy_score

pred = Data.apply(lambda x: prediction(x), axis=1)

accuracy_score(Data['Survived'], pred)
